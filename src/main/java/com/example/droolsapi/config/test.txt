// Create (INDV_ID, Row) pairs — Rows are serializable
val factsByIndvRDD = srcDF.rdd.map { r =>
  val indvId: Long = Option(r.getAs[Any]("INDV_ID")) match {
    case Some(n: java.lang.Long) => n
    case Some(n: java.lang.Integer) => n.toLong
    case _ => -1L
  }
  (indvId, r)
}




val resultsPairRDD = factsByIndvRDD
  .groupByKey()
  .flatMap { case (indvId, rowIter) =>
    // reconstruct models locally — no serialization issue
    val factSeq = rowIter.toSeq.map(toModel)
    fireRulesForIndv(kbaseBc.value, indvId, factSeq)
  }
