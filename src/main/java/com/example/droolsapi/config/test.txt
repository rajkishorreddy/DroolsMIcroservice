// build the KieBase once on the driver
val kbase = buildKieBaseFromDbfs("dbfs:/FileStore/rules")

// broadcast the KieBase to executors so each task can build sessions
val kbaseBc = spark.sparkContext.broadcast(kbase)

// group by INDV_ID on executors, run Drools per INDV_ID
val resultsPairRDD = factsByIndvRDD
  .groupByKey() // RDD[(Long, Iterable[CommonDataModel])]
  .flatMap { case (indvId, factIter) =>
    val factSeq = factIter.toSeq
    // use the SAME helper you already have
    fireRulesForIndv(kbaseBc.value, indvId, factSeq)
    // fireRulesForIndv returns Seq[(Long, String)]
  }

// convert the RDD[(Long, String)] -> DataFrame
import spark.implicits._
val resultsDF = resultsPairRDD.toDF("INDV_ID", "RULE_STATUS")

println("âœ… Final results per INDV_ID:")
resultsDF.show(truncate=false)
