from databricks.sdk import WorkspaceClient
import time

# Initialize client
w = WorkspaceClient()

CLUSTER_ID = "<your-cluster-id>"
JAR_PATH = "dbfs:/FileStore/jars/CommonDataObject-1.0.jar"

def uninstall_all_libs(cluster_id: str):
    """Uninstall all libraries from cluster"""
    libs = w.libraries.list(cluster_id)
    for lib in libs:
        print(f"Uninstalling {lib.library} ...")
        w.libraries.uninstall(cluster_id=cluster_id, library=lib.library)

    # Wait until all libraries are gone
    while True:
        libs = w.libraries.list(cluster_id)
        if not libs:  # clean
            print("âœ… All libraries uninstalled.")
            break
        print("Waiting for libraries to detach...")
        time.sleep(10)

def install_fat_jar(cluster_id: str, jar_path: str):
    """Install single fat JAR"""
    lib = {"jar": jar_path}
    w.libraries.install(cluster_id=cluster_id, library=lib)

    # Wait until it's active
    while True:
        libs = w.libraries.list(cluster_id)
        if libs and libs[0].status == "INSTALLED":
            print(f"âœ… JAR {jar_path} installed successfully")
            break
        print("Waiting for JAR to be installed...")
        time.sleep(10)

# --- Run cleanup + install ---
print("1) Removing old libraries...")
uninstall_all_libs(CLUSTER_ID)

print("2) Installing fat JAR...")
install_fat_jar(CLUSTER_ID, JAR_PATH)

print("ðŸŽ‰ Done. Cluster now has only your fat JAR attached.")
